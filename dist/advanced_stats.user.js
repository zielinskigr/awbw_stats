// ==UserScript==
// @name          AWBW Stats
// @namespace     https://github.com/zielinskigr/awbw_stats/
// @version       0.2.6
// @author        zielinskigr
// @source        https://github.com/zielinskigr/awbw_stats/
// @match         https://awbw.amarriner.com/2030.php*
// @require       https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js
// @icon          https://raw.githubusercontent.com/zielinskigr/awbw_stats/main/res/img/stats128.png
// @description   Enchanced Stats Charts for Advance Wars By Web
// ==/UserScript==


/******/ (() => { // webpackBootstrap
var __webpack_exports__ = {};
(()=>{"use strict";async function t(t){return await new Promise((a=>setTimeout(a,t)))}async function a(t,a=0){return(await fetch("https://awbw.amarriner.com/api/game/load_replay.php",{method:"POST",body:JSON.stringify({gameId:t,turn:a,initial:!0})})).json()}const e=(t,a)=>{let e=0,n=0,r=0;return Object.values(t.actions).forEach((i=>{if("Power"===i.action&&(a[playerId].coPowers[turnNumber]++,i.hpChange&&(i.hpChange.hpGain&&i.hpChange.hpGain.players.forEach((t=>{Object.values(a[t].units[turnNumber]).forEach((e=>{a[t].units[turnNumber][e.units_id].units_hit_points+=i.hpChange.hpGain.hp,a[t].units[turnNumber][e.units_id].units_hit_points>=10&&(a[t].units[turnNumber][e.units_id].units_hit_points=10)}))})),i.hpChange.hpLoss&&i.hpChange.hpLoss.players.forEach((t=>{Object.values(a[t].units[turnNumber]).forEach((e=>{a[t].units[turnNumber][e.units_id].units_hit_points+=i.hpChange.hpLoss.hp,a[t].units[turnNumber][e.units_id].units_hit_points<=0&&(a[t].units[turnNumber][e.units_id].units_hit_points=0)}))})))),"Capt"===i.action&&20==i.buildingInfo.buildings_capture&&e++,"Fire"===i.action){let e=i.attacker.units_id,s=a[playerId].units[turnNumber][e].units_players_id,u=a[playerId].units[turnNumber][e].units_cost,o=a[playerId].units[turnNumber][e].units_hit_points,c=i.attacker.units_hit_points;10!=c&&(0==c?(r=Math.round(u/10*o),a[playerId].units[turnNumber][e].units_hit_points=0):(r=Math.round(u/10*(o-c)),a[playerId].units[turnNumber][e].units_hit_points=c));let d=i.defender.units_id,l=t.gameState.units[d].units_players_id,m=a[playerId].units[turnNumber][d].units_cost,p=a[playerId].units[turnNumber][d].units_hit_points,h=i.defender.units_hit_points;10!=h&&(0==h?(n=Math.round(m/10*p),a[playerId].units[turnNumber][d].units_hit_points=0):(n=Math.round(m/10*(p-h)),a[playerId].units[turnNumber][d].units_hit_points=h)),a[s].damageDealt[turnNumber]+=n,a[l].damageDealt[turnNumber]+=r}})),{captures:e,chartData:a}};const n=t=>{t.attributes=t.attributes||[],t.classes=t.classes||[],t.children=t.children||[];const a=document.createElement(t.tag);return a.classList.add(...t.classes),t.attributes.forEach((([t,e])=>{a.setAttribute(t,e)})),a.innerText="",t.children.forEach((t=>{"string"==typeof t?a.innerText+=t:a.appendChild(t)})),a},r={fundschart:{name:"Total Funds Generated",button:{id:"fundsbutton",children:"Total Funds",chartName:"fundschart"},dataset:[{name:"fundsDataSet",type:"line"}],data:"funds"},incomechart:{name:"Income",button:{id:"incomebutton",children:"Income",chartName:"incomechart"},dataset:[{name:"incomeDataSet",type:"line"}],data:"income"},ucchart:{name:"Unit Count",button:{id:"ucbutton",children:"Unit Count",chartName:"ucchart"},dataset:[{name:"ucDataSet",type:"line"}],data:"unitCount"},uvchart:{name:"Unit Value",button:{id:"uvbutton",children:"Army Value",chartName:"uvchart"},dataset:[{name:"uvDataSet",type:"line"}],data:"unitValue"},hpchart:{name:"Unit HP",button:{id:"hpbutton",children:"Unit HP",chartName:"hpchart"},dataset:[{name:"hpDataSet",type:"line"}],data:"unitHP"},capturechart:{name:"Caps",button:{id:"capturebutton",children:"Caps",chartName:"capturechart"},dataset:[{name:"captureDataSet",type:"bar"}],data:"captureCount"},damagedealtchart:{name:"Damage Dealt",button:{id:"damagedealtbutton",children:"Damage Dealt",chartName:"damagedealtchart"},dataset:[{name:"damageDealtDataSet",type:"bar"}],data:"damageDealt"}},i={1:{primary:"#F46243",secondary:"#F89F8B",tertiary:"#D4310C"},2:{primary:"#446EFF",secondary:"#99AFFF",tertiary:"#001F8F"},3:{primary:"#12D815",secondary:"#8EF690",tertiary:"#064B07"},4:{primary:"#FBD412",secondary:"#FDE986",tertiary:"#B59703"},5:{primary:"#8A3E96",secondary:"#C78BD0",tertiary:"#5D2965"},6:{primary:"#C4443D",secondary:"#CF6863",tertiary:"#9C3530"},7:{primary:"#999B98",secondary:"#C2C2C1",tertiary:"#525251"},8:{primary:"#C58950",secondary:"#DBB694",tertiary:"#8A5A2E"},9:{primary:"#FCA339",secondary:"#FDC886",tertiary:"#DD7B03"},10:{primary:"#CBDDBA",secondary:"#A2C284",tertiary:"#6F964A"},16:{primary:"#1B43BD",secondary:"#3B65E3",tertiary:"#122D7D"},17:{primary:"#FE68CF",secondary:"#FE9ADF",tertiary:"#FD0DB1"},19:{primary:"#3ACFC1",secondary:"#7CDFD5",tertiary:"#208379"},20:{primary:"#CE64FE",secondary:"#DF9AFE",tertiary:"#A602F2"},21:{primary:"#5F7C0C",secondary:"#8DBA12",tertiary:"#B3E920"},22:{primary:"#BB534F",secondary:"#C66F6C",tertiary:"#E2B7B6"}};async function s(){const s=document.getElementById("gamecontainer"),u=function(){let t=[],a=[];Object.keys(r).forEach((e=>{let i=n({tag:"div",attributes:[["id",r[e].button.id]],children:[r[e].button.children]});i.onclick=()=>{Object.keys(r).forEach((t=>{document.getElementById(r[t].button.chartName).setAttribute("style","display: none;max-width: 100%!important;")})),document.getElementById(r[e].button.chartName).setAttribute("style","display: block;max-width: 100%!important;")};let s=n({tag:"canvas",attributes:[["style","display: none;max-width: 100%!important;"],["id",r[e].button.chartName]]});t.push(i),a.push(s)}));const e=n({tag:"div",attributes:[["style","position:absolute;right: -10px;background: #ddd;padding: 5px;top: -6px;"],["id","closebutton"]],children:["X"]});e.onclick=()=>{o.remove()};const i=n({tag:"div",attributes:[["id","chartsmenu"],["style","position:relative;display: flex;flex-flow: row;justify-content: space-around;margin-top: -25px;margin-bottom: 10px;cursor: pointer;"]],children:[...t,e]}),s=n({tag:"div",attributes:[["id","chartloader"]],children:["Fetching game data, this can take up to a minute depending on game length, please wait..."]}),u=n({tag:"div",attributes:[["id","chartswrapper"],["style","position: relative; width: 100%;"]],children:[s,...a]}),o=n({tag:"div",attributes:[["id","chartscontainer"],["style","position: relative; margin-top:20px;top: 33%;max-width: 1000px;width: 100%;height: 500px;padding: 40px 20px 20px;background: #fff;overflow: hidden;display: flex;flex-flow: column;"]],children:[i,u]});return o}();let o;s.appendChild(u);try{o=await async function(){const n=new URLSearchParams(window.location.search).get("games_id"),r=await async function(e){const n=await a(e),r=n.daySelector.length;let i,s={};if(2!==n.players.length)throw new Error("Can only work on 2 players, sorry.");n.players.forEach((async t=>{s[t.id]={player:t,turnsArray:[]}}));let u=0;for(;u<r;)await t(250),i=await a(e,u),s[i.gameState.currentTurnPId].turnsArray.push(i),u++;return s}(n);let i={};Object.keys(r).forEach((t=>{i[t]={name:r[t].turnsArray[0].gameState.players[t].users_username,turns:r[t].turnsArray.length,country:r[t].player.countries_id,units:[],funds:[],income:[],unitCount:[],unitValue:[],unitHP:[],unitHPCount:[],captureCount:[],damageDealt:[],damageTaken:[],coPowers:[]}}));const s=Object.keys(i);return Object.keys(r).forEach((t=>{let a=0;r[t].turnsArray.forEach(((n,r)=>{i[t].coPowers[r]=0,i[s[0]].damageDealt[r]||(i[s[0]].damageDealt[r]=0),i[s[0]].damageTaken[r]||(i[s[0]].damageTaken[r]=0),i[s[1]].damageDealt[r]||(i[s[1]].damageDealt[r]=0),i[s[1]].damageTaken[r]||(i[s[1]].damageTaken[r]=0),i[s[0]].units[r]=n.gameState.units,i[s[1]].units[r]=n.gameState.units,a+=n.gameState.players[t].players_funds;let u=0;Object.values(n.gameState.units).forEach((a=>{a.units_players_id==t&&(u+=a.units_hit_points)}));let o=u/n.gameState.players_units_count[t].total;const c=e(n,i);i=c.chartData;const d=c.captures;i[t].funds.push(a),i[t].income.push(n.gameState.players[t].players_income),i[t].unitCount.push(n.gameState.players_units_count[t].total),i[t].unitValue.push(n.gameState.players_units_count[t].value),i[t].unitHP.push(u),i[t].unitHPCount.push(o),i[t].captureCount.push(d)}))})),i}()}catch(t){u.remove(),console.log(t)}if(!o)throw u.remove(),new Error("Failed to load game data.");document.getElementById("chartloader").remove(),Object.keys(o);const c=Math.max(...(t=>{let a=[];return Object.values(t).forEach((t=>{a.push(t.turns)})),a})(o));!function(t,a){let e=function(t){let a={fundsDataSet:[],incomeDataSet:[],ucDataSet:[],uvDataSet:[],uvDataSet2:[],hpDataSet:[],hpcDataSet:[],ucuvDataSet:[],captureDataSet:[],damageDealtDataSet:[],damageTakenDataSet:[]};return Object.keys(r).forEach((e=>{"UC/UV"==r[e].name||Object.values(t).forEach((t=>{let n={label:t.name+" "+r[e].name,backgroundColor:i[t.country].primary,borderColor:i[t.country].primary,data:t[r[e].data]};a[r[e].dataset[0].name].push(n)}))})),a.ucuvDataSet=[...a.ucDataSet,...a.uvDataSet2],a}(t);Object.keys(r).forEach((t=>{const n={labels:a,datasets:e[r[t].dataset[0].name]},i={type:r[t].dataset[0].type,data:n,options:{}};new Chart(document.getElementById(t),i)})),document.getElementById("fundschart").setAttribute("style","display: block;")}(o,Array.from(Array(c).keys(),(t=>t+1)))}var u;u=function(){const t=n({tag:"div",classes:["game-tools-bg"],children:["Stats"]}),a=n({tag:"div",classes:["game-tools-btn","enchanced-stats"],children:[t]});a.onclick=()=>{s()};const e=n({tag:"section",children:[a]});document.getElementById("game-menu-controls").prepend(e)}(),"complete"===document.readyState||"interactive"===document.readyState?setTimeout(u,1):document.addEventListener("DOMContentLoaded",u)})();
/******/ })()
;